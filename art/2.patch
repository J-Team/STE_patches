From bb8e5f166270458c0b535378106ae528a394bf73 Mon Sep 17 00:00:00 2001
From: Chirayu Desai <cdesai@cyanogenmod.org>
Date: Sat, 9 Nov 2013 16:02:01 +0530
Subject: [PATCH] runtime: dexroot-on-cache: obey dalvik.vm.dexopt-data-only

Change-Id: Ie037706b1004e014c20f81c8fcdc219c46da57c7
---
 runtime/utils.cc |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/runtime/utils.cc b/runtime/utils.cc
index 8aabd15..285e337 100644
--- a/runtime/utils.cc
+++ b/runtime/utils.cc
@@ -1216,7 +1216,9 @@ std::string GetDalvikCacheOrDie(const char* android_data) {
 std::string GetDalvikCacheFilenameOrDie(const std::string& location) {
   std::string dalvik_cache(GetDalvikCacheOrDie(GetAndroidData()));
 #ifdef ALLOW_DEXROOT_ON_CACHE
-  if (StartsWith(location, "/system")) {
+  char dexoptDataOnly[PROPERTY_VALUE_MAX];
+  property_get("dalvik.vm.dexopt-data-only", dexoptDataOnly, "");
+  if ((StartsWith(location, "/system")) && (strcmp(dexoptDataOnly, "1") != 0)) {
       dalvik_cache = GetDalvikCacheOrDie(GetAndroidCache());
   }
 #endif
-- 
1.7.10.4

